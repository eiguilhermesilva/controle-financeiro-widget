<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
        }
        
        .financial-widget {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1080px;
            padding: 25px;
            position: relative;
            padding-bottom: 100px;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.9em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h1 i {
            color: #3498db;
        }
        
        .date-display {
            background: #f8f9fa;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 600;
            color: #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.9em;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-end;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
        }
        
        .input-group {
            flex: 1;
            min-width: 200px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 0.95em;
        }
        
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            font-size: 1em;
            color: #34495e;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .input-actions {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-income {
            background: linear-gradient(to right, #27ae60, #2ecc71);
        }
        
        .btn-income:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
        }
        
        .btn-expense {
            background: linear-gradient(to right, #e74c3c, #ff6b6b);
        }
        
        .btn-expense:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-edit {
            background: linear-gradient(to right, #3498db, #5dade2);
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .btn-edit:hover {
            background: linear-gradient(to right, #2980b9, #3498db);
        }
        
        .btn-delete {
            background: linear-gradient(to right, #e74c3c, #ff6b6b);
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .btn-delete:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }
        
        .btn-update {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
        }
        
        .btn-update:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(155, 89, 182, 0.3);
        }
        
        .btn-cancel {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
        }
        
        .btn-cancel:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(149, 165, 166, 0.3);
        }
        
        .btn-image {
            background: linear-gradient(to right, #3498db, #5dade2);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-image:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-csv {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-pdf {
            background: linear-gradient(to right, #e74c3c, #ff6b6b);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-json {
            background: linear-gradient(to right, #f39c12, #f1c40f);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-import {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-whatsapp {
            background: linear-gradient(to right, #25D366, #128C7E);
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 1.0em;
            justify-content: center;
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(37, 211, 102, 0.3);
        }
        
        .summary-section {
            display: flex;
            justify-content: space-around;
            padding: 0; 
            background: none;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
            min-width: 200px;
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .summary-item h3 {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 10px;
        }
        
        .summary-item p {
            font-size: 1.5em;
            font-weight: 700;
            margin: 5px 0 0;
        }
        
        #total-income {
            color: #3498DB;
        }
        
        #total-expense {
            color: #e74c3c;
        }
        
        #current-balance {
            color: #3498db;
        }
        
        #total-paid {
            color: #2c3e50;
        }
        
        #total-pending {
            color: #2c3e50;
        }
        
        /* NOVA SEÇÃO DE TRANSAÇÕES REFORMULADA */
        .transactions-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .transactions-title {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .transactions-count {
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            margin-left: 8px;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .transactions-table th,
        .transactions-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }
        
        .transactions-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.80em;
        }
        
        .transactions-table td {
            color: #34495e;
        }
        
        .transactions-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .transactions-table tbody tr:hover {
            background-color: #f0f7ff;
        }
        
        .type-income {
            color: #27ae60;
            font-weight: 500;
            background: rgba(39, 174, 96, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9em;
        }
        
        .type-expense {
            color: #e74c3c;
            font-weight: 500;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9em;
        }
        
        .category-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f1f2f6;
            color: #2f3542;
            font-weight: 500;
            display: inline-block;
        }
        
        .charts-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-container {
            width: 100%;
            max-width: 450px;
            height: 350px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-title {
            color: #2c3e50;
            font-size: 1.0em;
            font-weight: 500;
        }
        
        .chart-actions {
            display: flex;
            gap: 10px;
        }
        
        .chart-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .financial-health-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .health-message {
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .health-message i {
            font-size: 1.5em;
        }
        
        .health-positive {
            background: linear-gradient(to right, rgba(39, 174, 96, 0.15), rgba(46, 204, 113, 0.15));
            color: #27ae60;
            border-left: 5px solid #27ae60;
        }
        
        .health-neutral {
            background: linear-gradient(to right, rgba(241, 196, 15, 0.15), rgba(243, 156, 18, 0.15));
            color: #f39c12;
            border-left: 5px solid #f39c12;
        }
        
        .health-warning {
            background: linear-gradient(to right, rgba(230, 126, 34, 0.15), rgba(211, 84, 0, 0.15));
            color: #e67e22;
            border-left: 5px solid #e67e22;
        }
        
        .health-critical {
            background: linear-gradient(to right, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.15));
            color: #e74c3c;
            border-left: 5px solid #e74c3c;
        }
        
        .widget-footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9em;
            padding-top: 10px;
            border-top: 1px solid #eee;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding-bottom: 15px;
            background-color: #ffffff;
        }
        
        .edit-mode-banner {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            width: 100%;
            margin-top: 15px;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 5px;
            display: none;
        }
        
        .input-group.error input,
        .input-group.error select {
            border-color: #e74c3c;
        }
        
        .export-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: #2ecc71;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
        }
        
        .import-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .import-modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.5em;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .modal-content {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .file-input-wrapper {
            position: relative;
            margin: 15px 0;
        }
        
        .file-label {
            display: block;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background: #e3f2fd;
        }
        
        .file-label i {
            font-size: 2em;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
            text-align: center;
        }
        
        @keyframes slideIn {
            from { right: -300px; opacity: 0; }
            to { right: 20px; opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .back-to-top:hover {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
            transform: translateY(-3px);
        }
        
        /* NOVOS ESTILOS PARA BOTÕES MOBILE */
        .mobile-export-buttons {
            display: none; /* Oculto por padrão */
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .mobile-export-button {
            background: linear-gradient(to right, #3498db, #5dade2);
            border: none;
            border-radius: 8px;
            padding: 12px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 80px;
        }
        
        .mobile-export-button i {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .mobile-export-button.csv {
            background: linear-gradient(to right, #27ae60, #2ecc71);
        }
        
        .mobile-export-button.pdf {
            background: linear-gradient(to right, #e74c3c, #ff6b6b);
        }
        
        .mobile-export-button.json {
            background: linear-gradient(to right, #f39c12, #f1c40f);
        }
        
        .mobile-export-button.import {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
        }
        
        .mobile-export-button.whatsapp {
            background: linear-gradient(to right, #25D366, #128C7E);
        }
        
        .mobile-export-button.image {
            background: linear-gradient(to right, #3498db, #5dade2);
        }
        
        .mobile-export-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .mobile-export-button span {
            font-size: 0.75em;
        }
        
        @media (min-width: 769px) {
            .back-to-top {
                position: absolute;
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .financial-widget {
                padding: 15px;
                padding-bottom: 120px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .input-section {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                gap: 15px;
            }
            
            .input-actions {
                flex-direction: column;
                justify-content: center;
                align-items: stretch;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                padding: 12px 15px;
                font-size: 0.9em;
            }
            
            .summary-section {
                flex-direction: column;
                gap: 15px;
                padding: 0;
            }
            
            .summary-item {
                width: 100%;
                min-width: 100%;
                padding: 20px;
                margin: 0 0 15px 0;
            }
            
            .summary-item p {
                font-size: 1.4em;
            }
            
            .charts-container {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .chart-container {
                max-width: 100%;
                height: 300px;
                padding: 15px;
            }
            
            .transactions-section {
                padding: 15px;
            }
            
            .transactions-title {
                font-size: 1.0em;
                justify-content: center;
            }
            
            .health-message {
                font-size: 1.0em;
                padding: 12px;
                flex-direction: column;
                text-align: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-edit, .btn-delete {
                padding: 8px 10px;
                font-size: 0.85em;
            }
            
            .transactions-table, 
            .transactions-table thead, 
            .transactions-table tbody, 
            .transactions-table th, 
            .transactions-table td, 
            .transactions-table tr {
                display: block;
            }
            
            .transactions-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .transactions-table tr {
                border: 1px solid #ddd;
                margin-bottom: 15px;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                position: relative;
            }
            
            .transactions-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
                font-size: 0.85em;
                padding: 10px 15px;
            }
            
            .transactions-table td:last-child {
                border-bottom: 0;
                text-align: center;
                padding-left: 10px;
            }
            
            .transactions-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #555;
                font-size: 0.85em;
            }
            
            .transactions-table td[data-label="Paga?"][data-is-income="true"]::before {
                display: none;
            }
            
            .action-cell {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 10px 0;
            }
            
            .action-cell .btn {
                width: auto;
                padding: 8px 15px;
                font-size: 0.9em;
                display: inline-flex;
            }
            
            .action-cell .btn span {
                display: none;
            }
            
            .type-income, .type-expense {
                font-size: 0.9em;
                padding: 4px 8px;
            }
            
            .category-badge {
                font-size: 0.75em;
            }
            
            .export-section {
                display: none; /* Ocultar botões padrão em mobile */
            }
            
            .mobile-export-buttons {
                display: grid; /* Mostrar botões compactos em mobile */
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.6em;
            }
            
            .date-display {
                font-size: 0.8em;
                padding: 6px 15px;
            }
            
            .input-group input, 
            .input-group select {
                padding: 12px;
            }
            
            .summary-item h3 {
                font-size: 0.9em;
            }
            
            .summary-item p {
                font-size: 1.3em;
            }
            
            .transactions-table td {
                font-size: 0.8em;
                padding: 10px 15px 10px 50%;
            }
            
            .transactions-table td::before {
                font-size: 1.0em;
            }
            
            .btn-image, .btn-csv, .btn-pdf, .btn-json, .btn-import, .btn-whatsapp {
                padding: 14px;
                font-size: 0.95em;
            }
            
            .action-cell .btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            
            .action-cell .btn i {
                font-size: 0.9em;
            }
            
            .back-to-top {
                bottom: 70px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
            
            .mobile-export-button {
                padding: 8px 3px;
                font-size: 0.7em;
            }
            
            .mobile-export-button i {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="export-notification" id="export-notification">
        <i class="fas fa-check-circle"></i> <span id="notification-text"></span>
    </div>
    
    <div class="import-overlay" id="import-overlay">
        <div class="import-modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-import"></i> Importar Dados Financeiros</h2>
                <button class="close-modal" id="close-import-modal">&times;</button>
            </div>
            <div class="modal-content">
                <p>Selecione um arquivo JSON exportado anteriormente para importar seus dados financeiros.</p>
                
                <div class="file-input-wrapper">
                    <label class="file-label" for="import-file-input">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div>Clique para selecionar um arquivo</div>
                        <div class="file-name" id="file-name-display">Nenhum arquivo selecionado</div>
                    </label>
                    <input type="file" id="import-file-input" class="file-input" accept=".json">
                </div>
                
                <div class="import-options">
                    <p><strong>Opções de importação:</strong></p>
                    <div style="margin: 10px 0;">
                        <input type="radio" id="merge-data" name="import-option" value="merge" checked>
                        <label for="merge-data">Mesclar com dados existentes</label>
                    </div>
                    <div>
                        <input type="radio" id="replace-data" name="import-option" value="replace">
                        <label for="replace-data">Substituir todos os dados existentes</label>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-import">Cancelar</button>
                <button class="btn btn-update" id="confirm-import" disabled>Importar Dados</button>
            </div>
        </div>
    </div>
    
    <div class="financial-widget" id="financial-widget-content">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Controle Financeiro Pessoal</h1>
            <div class="date-display">
                <i class="fas fa-calendar-alt"></i> <span id="current-date"></span>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="description"><i class="fas fa-pen"></i> Descrição:</label>
                <input type="text" id="description" placeholder="Ex: Salário, Aluguel" required>
            </div>
            <div class="input-group">
                <label for="value"><i class="fas fa-money-bill-wave"></i> Valor (R$):</label>
                <input type="number" id="value" placeholder="Ex: 1500.00" step="0.01" required>
            </div>
            <div class="input-group">
                <label for="category"><i class="fas fa-tag"></i> Categoria:</label>
                <select id="category" required>
                    <option value="" disabled selected>Selecione uma categoria</option>
                </select>
                <div class="error-message" id="category-error">Selecione uma categoria válida para este tipo de transação</div>
            </div>
            <div class="input-actions">
                <button id="add-income" class="btn btn-income">
                    <i class="fas fa-plus-circle"></i> Adicionar Renda
                </button>
                <button id="add-expense" class="btn btn-expense">
                    <i class="fas fa-minus-circle"></i> Adicionar Despesa
                </button>
            </div>
            
            <div id="edit-mode-section" class="action-buttons" style="display: none;">
                <button id="update-transaction" class="btn btn-update">
                    <i class="fas fa-save"></i> Atualizar Transação
                </button>
                <button id="cancel-edit" class="btn btn-cancel">
                    <i class="fas fa-times"></i> Cancelar Edição
                </button>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-item">
                <h3><i class="fas fa-arrow-up"></i> Renda Total:</h3>
                <p id="total-income">R$ 0.00</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-arrow-down"></i> Despesa Total:</h3>
                <p id="total-expense">R$ 0.00</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-balance-scale"></i> Saldo Atual:</h3>
                <p id="current-balance">R$ 0.00</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-check-circle"></i> Total Pago:</h3>
                <p id="total-paid">R$ 0.00</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-clock"></i> Total Pendente:</h3>
                <p id="total-pending">R$ 0.00</p>
            </div>
        </div>

        <!-- NOVA SEÇÃO DE TRANSAÇÕES REFORMULADA -->
        <div class="transactions-section">
            <div class="transactions-header">
                <div class="transactions-title">
                    <i class="fas fa-list"></i> Detalhes das Transações
                    <span class="transactions-count" id="transactions-indicator">0</span>
                </div>
            </div>
            
            <table class="transactions-table" id="transactions-table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Paga?</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- As transações serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="charts-section">
            <div class="section-title"><i class="fas fa-chart-pie"></i> Gráficos de Finanças</div>
            <div class="charts-container">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Distribuição de Despesas</div>
                    </div>
                    <canvas id="expense-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Análise Percentual</div>
                    </div>
                    <canvas id="summary-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="financial-health-section">
            <div class="section-title"><i class="fas fa-heartbeat"></i> Saúde Financeira</div>
            <div class="health-message" id="financial-health-message">
                <i class="fas fa-info-circle"></i>
                <span>Adicione transações para analisar sua saúde financeira</span>
            </div>
        </div>

        <!-- Seção de exportação original (oculta em mobile) -->
        <div class="export-section">
            <button id="generate-image" class="btn btn-image">
                <i class="fas fa-camera"></i> Gerar Imagem do Relatório
            </button>
            <button id="export-csv" class="btn btn-csv">
                <i class="fas fa-file-csv"></i> Exportar para Planilha (CSV)
            </button>
            <button id="export-pdf" class="btn btn-pdf">
                <i class="fas fa-file-pdf"></i> Exportar para PDF
            </button>
            <button id="export-json" class="btn btn-json">
                <i class="fas fa-file-export"></i> Exportar Dados (JSON)
            </button>
            <button id="import-data" class="btn btn-import">
                <i class="fas fa-file-import"></i> Importar Dados (JSON)
            </button>
            <button id="share-whatsapp" class="btn btn-whatsapp">
                <i class="fab fa-whatsapp"></i> Compartilhar via WhatsApp
            </button>
        </div>
        
        <!-- NOVA SEÇÃO DE BOTÕES COMPACTOS PARA MOBILE -->
        <div class="mobile-export-buttons">
            <button class="mobile-export-button pdf" id="mobile-pdf">
                <i class="fas fa-file-pdf"></i>
                <span>PDF</span>
            </button>
            <button class="mobile-export-button csv" id="mobile-csv">
                <i class="fas fa-file-csv"></i>
                <span>CSV</span>
            </button>
            <button class="mobile-export-button json" id="mobile-json">
                <i class="fas fa-file-export"></i>
                <span>JSON</span>
            </button>
            <button class="mobile-export-button import" id="mobile-import">
                <i class="fas fa-file-import"></i>
                <span>Importar</span>
            </button>
            <button class="mobile-export-button whatsapp" id="mobile-whatsapp">
                <i class="fab fa-whatsapp"></i>
                <span>WhatsApp</span>
            </button>
            <button class="mobile-export-button image" id="mobile-image">
                <i class="fas fa-camera"></i>
                <span>Imagem</span>
            </button>
        </div>
        
        <div class="back-to-top" id="back-to-top">
            <i class="fas fa-arrow-up"></i>
        </div>

        <div class="widget-footer">
            Guilherme S. Vanderley © 2025 - Todos os direitos reservados.
        </div>
    </div>

    <script>
        // Referências aos elementos do DOM
        const descriptionInput = document.getElementById('description');
        const valueInput = document.getElementById('value');
        const categoryInput = document.getElementById('category');
        const addIncomeBtn = document.getElementById('add-income');
        const addExpenseBtn = document.getElementById('add-expense');
        const totalIncomeElem = document.getElementById('total-income');
        const totalExpenseElem = document.getElementById('total-expense');
        const currentBalanceElem = document.getElementById('current-balance');
        const totalPaidElem = document.getElementById('total-paid');
        const totalPendingElem = document.getElementById('total-pending');
        const transactionsTableBody = document.querySelector('#transactions-table tbody');
        const generateImageBtn = document.getElementById('generate-image');
        const exportCsvBtn = document.getElementById('export-csv');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportJsonBtn = document.getElementById('export-json');
        const importDataBtn = document.getElementById('import-data');
        const expenseChartCanvas = document.getElementById('expense-chart').getContext('2d');
        const summaryChartCanvas = document.getElementById('summary-chart').getContext('2d');
        const financialWidgetContent = document.getElementById('financial-widget-content');
        const currentDateElem = document.getElementById('current-date');
        const updateBtn = document.getElementById('update-transaction');
        const cancelBtn = document.getElementById('cancel-edit');
        const editModeSection = document.getElementById('edit-mode-section');
        const categoryError = document.getElementById('category-error');
        const exportNotification = document.getElementById('export-notification');
        const notificationText = document.getElementById('notification-text');
        const importOverlay = document.getElementById('import-overlay');
        const closeImportModal = document.getElementById('close-import-modal');
        const cancelImportBtn = document.getElementById('cancel-import');
        const confirmImportBtn = document.getElementById('confirm-import');
        const importFileInput = document.getElementById('import-file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const financialHealthMessage = document.getElementById('financial-health-message');
        const transactionsIndicator = document.getElementById('transactions-indicator');
        const backToTopBtn = document.getElementById('back-to-top');
        const shareWhatsappBtn = document.getElementById('share-whatsapp');
        
        // Referências para os botões mobile
        const mobilePdfBtn = document.getElementById('mobile-pdf');
        const mobileCsvBtn = document.getElementById('mobile-csv');
        const mobileJsonBtn = document.getElementById('mobile-json');
        const mobileImportBtn = document.getElementById('mobile-import');
        const mobileWhatsappBtn = document.getElementById('mobile-whatsapp');
        const mobileImageBtn = document.getElementById('mobile-image');
        
        // Atualizar data atual
        const now = new Date();
        currentDateElem.textContent = now.toLocaleDateString('pt-BR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Categorias pré-definidas
        const incomeCategories = ["Salário", "Freelance", "Investimentos", "Presente", "Outros"];
        const expenseCategories = ["Moradia", "Alimentação", "Transporte", "Lazer", "Saúde", "Educação", "Outros"];
        
        // Preencher o select de categorias com grupos
        function populateCategories() {
            categoryInput.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';
            
            // Grupo de Renda
            const incomeGroup = document.createElement('optgroup');
            incomeGroup.label = 'Renda';
            incomeCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                incomeGroup.appendChild(option);
            });
            categoryInput.appendChild(incomeGroup);
            
            // Grupo de Despesas
            const expenseGroup = document.createElement('optgroup');
            expenseGroup.label = 'Despesas';
            expenseCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                expenseGroup.appendChild(option);
            });
            categoryInput.appendChild(expenseGroup);
        }
        
        // Inicialmente preencher com todas as categorias
        populateCategories();

        // Variáveis globais para armazenar os dados
        let transactions = [];
        let expenseChart;
        let summaryChart;
        let isEditMode = false;
        let currentEditId = null;
        let currentTransactionType = null;
        let importOption = "merge"; // merge ou replace

        // --- Funções Principais ---

        // Carrega as transações do Local Storage ao iniciar
        function loadTransactions() {
            const storedTransactions = localStorage.getItem('financialTransactions');
            if (storedTransactions) {
                transactions = JSON.parse(storedTransactions);
                
                // Inicializar propriedade 'paga' para transações antigas
                transactions.forEach(transaction => {
                    if (transaction.type === 'expense' && transaction.paga === undefined) {
                        transaction.paga = false;
                    }
                });
            }
            updateUI();
        }

        // Salva as transações no Local Storage
        function saveTransactions() {
            localStorage.setItem('financialTransactions', JSON.stringify(transactions));
        }

        // Valida se a categoria é compatível com o tipo de transação
        function validateCategory(type, category) {
            if (type === 'income') {
                return incomeCategories.includes(category);
            } else {
                return expenseCategories.includes(category);
            }
        }

        // Mostra mensagem de erro na categoria
        function showCategoryError(message) {
            categoryError.textContent = message;
            categoryError.style.display = 'block';
            categoryInput.parentElement.classList.add('error');
        }

        // Esconde a mensagem de erro na categoria
        function hideCategoryError() {
            categoryError.style.display = 'none';
            categoryInput.parentElement.classList.remove('error');
        }

        // Adiciona uma nova transação
        function addTransaction(type) {
            const description = descriptionInput.value.trim();
            const value = parseFloat(valueInput.value);
            const category = categoryInput.value;
            
            // Resetar mensagens de erro
            hideCategoryError();

            if (!description || isNaN(value) || value <= 0 || !category) {
                alert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }
            
            // Validar categoria compatível com o tipo
            if (!validateCategory(type, category)) {
                let message = '';
                if (type === 'income') {
                    message = 'Selecione uma categoria de renda válida';
                } else {
                    message = 'Selecione uma categoria de despesa válida';
                }
                showCategoryError(message);
                return;
            }

            const transaction = {
                id: Date.now(), // ID único para a transação
                description,
                category,
                value: type === 'expense' ? -value : value,
                type,
                // Para despesas, inicializar como não paga
                ...(type === 'expense' && { paga: false })
            };

            transactions.push(transaction);
            saveTransactions();
            updateUI();
            clearInputs();
        }

        // Atualiza uma transação existente
        function updateTransaction() {
            const description = descriptionInput.value.trim();
            const value = parseFloat(valueInput.value);
            const category = categoryInput.value;
            
            // Resetar mensagens de erro
            hideCategoryError();

            if (!description || isNaN(value) || value <= 0 || !category) {
                alert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }
            
            // Validar categoria compatível com o tipo
            if (!validateCategory(currentTransactionType, category)) {
                let message = '';
                if (currentTransactionType === 'income') {
                    message = 'Selecione uma categoria de renda válida';
                } else {
                    message = 'Selecione uma categoria de despesa válida';
                }
                showCategoryError(message);
                return;
            }

            // Encontra o índice da transação sendo editada
            const index = transactions.findIndex(t => t.id === currentEditId);
            
            if (index !== -1) {
                transactions[index].description = description;
                transactions[index].value = currentTransactionType === 'expense' ? -value : value;
                transactions[index].category = category;
                
                saveTransactions();
                updateUI();
                cancelEditMode();
            }
        }

        // Remove uma transação
        function deleteTransaction(id) {
            if (confirm('Tem certeza que deseja excluir esta transação?')) {
                transactions = transactions.filter(transaction => transaction.id !== id);
                saveTransactions();
                updateUI();
            }
        }

        // Ativa o modo de edição
        function activateEditMode(id) {
            const transaction = transactions.find(t => t.id === id);
            
            if (transaction) {
                isEditMode = true;
                currentEditId = id;
                currentTransactionType = transaction.type;
                
                // Preencher os campos com os dados da transação
                descriptionInput.value = transaction.description;
                valueInput.value = Math.abs(transaction.value);
                categoryInput.value = transaction.category;
                
                // Mostrar botões de atualização/cancelamento
                editModeSection.style.display = 'flex';
                
                // Rolar até o formulário
                descriptionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Cancela o modo de edição
        function cancelEditMode() {
            isEditMode = false;
            currentEditId = null;
            currentTransactionType = null;
            editModeSection.style.display = 'none';
            clearInputs();
            hideCategoryError();
        }

        // Atualiza a interface do usuário (tabela, resumos e gráficos)
        function updateUI() {
            updateSummary();
            renderTransactionsTable();
            updateCharts();
            updateFinancialHealthMessage();
            updateTransactionsIndicator();
        }

        // Atualiza os totais de renda, despesa e saldo
        function updateSummary() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalPaid = 0;
            let totalPending = 0;

            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.value;
                } else {
                    const expenseValue = Math.abs(transaction.value);
                    totalExpense += expenseValue;
                    
                    if (transaction.paga) {
                        totalPaid += expenseValue;
                    } else {
                        totalPending += expenseValue;
                    }
                }
            });

            const currentBalance = totalIncome - totalExpense;

            totalIncomeElem.textContent = formatCurrency(totalIncome);
            totalExpenseElem.textContent = formatCurrency(totalExpense);
            currentBalanceElem.textContent = formatCurrency(currentBalance);
            totalPaidElem.textContent = formatCurrency(totalPaid);
            totalPendingElem.textContent = formatCurrency(totalPending);
            
            // Altera a cor do saldo atual conforme o valor
            if (currentBalance > 0) {
                currentBalanceElem.style.color = '#27ae60'; // Verde
            } else if (currentBalance < 0) {
                currentBalanceElem.style.color = '#e74c3c'; // Vermelho
            } else {
                currentBalanceElem.style.color = '#3498db'; // Azul (padrão)
            }
            
            // Retornar os valores para uso na mensagem de saúde financeira
            return { totalIncome, totalExpense, currentBalance };
        }

        // Atualiza o indicador de transações
        function updateTransactionsIndicator() {
            transactionsIndicator.textContent = transactions.length;
        }

        // Renderiza as transações na tabela
        function renderTransactionsTable() {
            transactionsTableBody.innerHTML = '';

            // Ordenar transações por data (mais recentes primeiro)
            const sortedTransactions = [...transactions].sort((a, b) => b.id - a.id);

            sortedTransactions.forEach(transaction => {
                const row = transactionsTableBody.insertRow();
                
                // Tipo
                const typeCell = row.insertCell();
                typeCell.innerHTML = `<span class="${transaction.type === 'income' ? 'type-income' : 'type-expense'}">${transaction.type === 'income' ? 'Renda' : 'Despesa'}</span>`;
                typeCell.setAttribute('data-label', 'Tipo');

                // Descrição
                const descriptionCell = row.insertCell();
                descriptionCell.textContent = transaction.description;
                descriptionCell.setAttribute('data-label', 'Descrição');
                
                // Categoria
                const categoryCell = row.insertCell();
                categoryCell.innerHTML = `<span class="category-badge">${transaction.category}</span>`;
                categoryCell.setAttribute('data-label', 'Categoria');

                // Valor
                const valueCell = row.insertCell();
                valueCell.textContent = formatCurrency(Math.abs(transaction.value));
                valueCell.setAttribute('data-label', 'Valor');

                // Paga? (apenas para despesas)
                const paidCell = row.insertCell();
            if (transaction.type === 'expense') {
                paidCell.setAttribute('data-label', 'Paga?');
                paidCell.setAttribute('data-is-income', 'false');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = transaction.paga || false;
                checkbox.addEventListener('change', () => {
                    transaction.paga = checkbox.checked;
                    saveTransactions();
                    updateUI();
                });
                paidCell.appendChild(checkbox);
            } else {
                paidCell.setAttribute('data-label', 'Paga?');
                paidCell.setAttribute('data-is-income', 'true');
                paidCell.textContent = '-';
            }

            // Ações
            const actionsCell = row.insertCell();
            actionsCell.setAttribute('data-label', 'Ações');
            actionsCell.className = 'action-cell';
            
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<i class="fas fa-edit"></i> <span>Editar</span>';
            editBtn.classList.add('btn', 'btn-edit');
            editBtn.onclick = () => activateEditMode(transaction.id);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> <span>Excluir</span>';
            deleteBtn.classList.add('btn', 'btn-delete');
            deleteBtn.onclick = () => deleteTransaction(transaction.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });
    }

    // Atualiza os gráficos
    function updateCharts() {
        // Calcular valores para os gráficos
        const expenseByCategory = {};
        let totalIncome = 0;
        let totalExpense = 0;
        
        transactions.forEach(t => {
            if (t.type === 'income') {
                totalIncome += t.value;
            } else {
                totalExpense += Math.abs(t.value);
                
                // Agrupar despesas por categoria
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Math.abs(t.value);
            }
        });
        
        const currentBalance = totalIncome - totalExpense;
        
        // Calcular porcentagens para o gráfico de barras
        const incomePercent = totalIncome > 0 ? 100 : 0;
        const expensePercent = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 0;
        const balancePercent = totalIncome > 0 ? (currentBalance / totalIncome) * 100 : 0;
        
        // Atualizar gráfico de despesas
        updateExpenseChart(Object.keys(expenseByCategory), Object.values(expenseByCategory));
        
        // Atualizar gráfico de porcentagens
        updateSummaryChart(incomePercent, expensePercent, balancePercent);
    }

    // Atualizar gráfico de despesas (pizza)
    function updateExpenseChart(labels, data) {
        if (expenseChart) {
            expenseChart.destroy();
        }
        
        // Se não houver despesas, exibir mensagem
        if (data.length === 0) {
            expenseChart = new Chart(expenseChartCanvas, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#f0f0f0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        beforeDraw: function(chart) {
                            const ctx = chart.ctx;
                            const width = chart.width;
                            const height = chart.height;
                            
                            ctx.restore();
                            ctx.font = "16px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = '#7f8c8d';
                            ctx.fillText('Nenhuma despesa registrada', width / 2, height / 2);
                            ctx.save();
                        }
                    }
                }
            });
            return;
        }

        expenseChart = new Chart(expenseChartCanvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                        '#8D6E63', '#4DD0E1', '#F44336', '#9C27B0'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 11
                            },
                            color: '#555'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Atualizar gráfico de porcentagens (barras horizontais)
    function updateSummaryChart(incomePercent, expensePercent, balancePercent) {
        if (summaryChart) {
            summaryChart.destroy();
        }

        summaryChart = new Chart(summaryChartCanvas, {
            type: 'bar',
            data: {
                labels: ['Rendas', 'Gastos', 'Saldo'],
                datasets: [{
                    label: 'Porcentagem em relação à renda total',
                    data: [incomePercent, expensePercent, balancePercent],
                    backgroundColor: [
                        'rgba(39, 174, 96, 0.7)',   // Verde para rendas
                        'rgba(231, 76, 60, 0.7)',   // Vermelho para gastos
                        'rgba(52, 152, 219, 0.7)'   // Azul para saldo
                    ],
                    borderColor: [
                        'rgba(39, 174, 96, 1)',
                        'rgba(231, 76, 60, 1)',
                        'rgba(52, 152, 219, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.x.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Porcentagem (%)',
                            font: {
                                size: 14
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Atualiza a mensagem de saúde financeira
    function updateFinancialHealthMessage() {
        const { totalIncome, totalExpense, currentBalance } = updateSummary();
        
        let message = "";
        let icon = "";
        let healthClass = "health-neutral";
        
        // Se não há transações
        if (transactions.length === 0) {
            message = "Adicione transações para analisar sua saúde financeira";
            icon = "fas fa-info-circle";
            healthClass = "health-neutral";
        }
        // Saldo negativo
        else if (currentBalance < 0) {
            message = "Cuidado! Seu saldo está negativo. Considere reduzir despesas ou aumentar rendas.";
            icon = "fas fa-exclamation-triangle";
            healthClass = "health-critical";
        }
        // Despesas > 75% da renda
        else if (totalIncome > 0 && (totalExpense / totalIncome) > 0.75) {
            message = "Atenção! Suas despesas estão acima de 75% da sua renda. Tente reduzir custos.";
            icon = "fas fa-exclamation-circle";
            healthClass = "health-warning";
        }
        // Despesas entre 50% e 75% da renda
        else if (totalIncome > 0 && (totalExpense / totalIncome) > 0.5) {
            message = "Sua saúde financeira está estável, mas você pode melhorar. Tente economizar mais.";
            icon = "fas fa-balance-scale";
            healthClass = "health-neutral";
        }
        // Situação saudável
        else {
            message = "Parabéns! Sua saúde financeira está excelente. Continue assim!";
            icon = "fas fa-check-circle";
            healthClass = "health-positive";
        }
        
        // Atualizar o elemento HTML
        financialHealthMessage.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
        financialHealthMessage.className = `health-message ${healthClass}`;
    }

    // Limpa os campos de entrada
    function clearInputs() {
        descriptionInput.value = '';
        valueInput.value = '';
        categoryInput.value = '';
        descriptionInput.focus();
        hideCategoryError();
    }

    // Formata o valor para moeda brasileira
    function formatCurrency(value) {
        return value.toLocaleString('pt-BR', { 
            style: 'currency', 
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Formata o valor para CSV (sem símbolo de moeda)
    function formatCurrencyForCSV(value) {
        return value.toLocaleString('pt-BR', { 
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Exportar para CSV com organização correta
    function exportToCSV() {
        // Verificar se existem transações
        if (transactions.length === 0) {
            alert('Não há transações para exportar!');
            return;
        }
        
        // Cabeçalho do CSV com colunas organizadas
        let csvContent = "Tipo;Descrição;Categoria;Valor;Paga?\n";
        
        // Ordenar transações por data (mais recentes primeiro)
        const sortedTransactions = [...transactions].sort((a, b) => b.id - a.id);
        
        // Adicionar cada transação
        sortedTransactions.forEach(transaction => {
            const type = transaction.type === 'income' ? 'Renda' : 'Despesa';
            // Remover quebras de linha e ponto-e-vírgula para evitar problemas
            const description = transaction.description.replace(/[\n;]/g, ' '); 
            const category = transaction.category;
            const value = formatCurrencyForCSV(Math.abs(transaction.value));
            // Apenas despesas têm informação de pagamento
            const paid = transaction.type === 'expense' ? (transaction.paga ? 'Sim' : 'Não') : '';
            
            // Adicionar linha ao CSV usando ponto-e-vírgula como separador
            csvContent += `${type};"${description}";${category};${value};${paid}\n`;
        });
        
        // Adicionar resumo financeiro
        let totalIncome = 0;
        let totalExpense = 0;
        let totalPaid = 0;
        let totalPending = 0;
        
        transactions.forEach(transaction => {
            if (transaction.type === 'income') {
                totalIncome += transaction.value;
            } else {
                const expenseValue = Math.abs(transaction.value);
                totalExpense += expenseValue;
                
                if (transaction.paga) {
                    totalPaid += expenseValue;
                } else {
                    totalPending += expenseValue;
                }
            }
        });
        
        const currentBalance = totalIncome - totalExpense;
        
        csvContent += "\n;;;;\n";
        csvContent += `Resumo Financeiro;;;;\n`;
        csvContent += `Renda Total;;;${formatCurrencyForCSV(totalIncome)}\n`;
        csvContent += `Despesa Total;;;${formatCurrencyForCSV(totalExpense)}\n`;
        csvContent += `Total Pago;;;${formatCurrencyForCSV(totalPaid)}\n`;
        csvContent += `Total Pendente;;;${formatCurrencyForCSV(totalPending)}\n`;
        csvContent += `Saldo Atual;;;${formatCurrencyForCSV(currentBalance)}\n`;
        
        // Criar link de download
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'transacoes_financeiras.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        notificationText.textContent = "Dados exportados para CSV com sucesso!";
        showExportNotification();
    }
    
    // Exportar dados para JSON
    function exportToJSON() {
        // Verificar se existem transações
        if (transactions.length === 0) {
            alert('Não há transações para exportar!');
            return;
        }
        
        // Criar objeto com os dados a serem exportados
        const exportData = {
            app: "Controle Financeiro",
            version: "1.0",
            timestamp: new Date().toISOString(),
            transactions: transactions
        };
        
        // Criar string JSON formatada
        const jsonData = JSON.stringify(exportData, null, 2);
        
        // Criar blob e link de download
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dados-financeiros-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        notificationText.textContent = "Dados exportados para JSON com sucesso!";
        showExportNotification();
    }
    
    // Importar dados de um arquivo JSON
    function importFromJSON(file, option) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Validar a estrutura do arquivo
                if (!data.transactions || !Array.isArray(data.transactions)) {
                    throw new Error("Formato de arquivo inválido");
                }
                
                // Processar os dados conforme a opção selecionada
                if (option === "replace") {
                    transactions = data.transactions;
                } else { // merge
                    // Mesclar transações, evitando duplicatas por ID
                    const existingIds = transactions.map(t => t.id);
                    const newTransactions = data.transactions.filter(t => !existingIds.includes(t.id));
                    transactions = [...transactions, ...newTransactions];
                }
                
                // Salvar e atualizar
                saveTransactions();
                updateUI();
                
                notificationText.textContent = `Dados importados com sucesso! (${data.transactions.length} transações)`;
                showExportNotification();
                
                // Fechar o modal de importação
                importOverlay.style.display = 'none';
                
            } catch (error) {
                console.error("Erro ao importar dados:", error);
                alert("Erro ao importar dados: " + error.message);
            }
        };
        
        reader.onerror = function() {
            alert("Erro ao ler o arquivo");
        };
        
        reader.readAsText(file);
    }
    
    // Geração de imagem
    async function generateImage() {
        try {
            const canvas = await html2canvas(financialWidgetContent, {
                scale: 2,
                useCORS: true,
                logging: false
            });

            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'relatorio_financeiro.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            notificationText.textContent = "Imagem do relatório gerada com sucesso!";
            showExportNotification();
        } catch (error) {
            console.error("Erro ao gerar imagem:", error);
            alert('Ocorreu um erro ao gerar a imagem. Tente novamente.');
        }
    }
    
    // Exportar para PDF com organização profissional
    async function exportToPDF() {
        try {
            // Verificar se existem transações
            if (transactions.length === 0) {
                alert('Não há transações para exportar!');
                return;
            }
            
            // Criar novo documento PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Configurações iniciais
            const margin = 15;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let yPos = margin;
            
            // Adicionar título com fundo colorido
            pdf.setFillColor(44, 62, 80); // Cor de fundo: #2c3e50
            pdf.rect(0, 0, pageWidth, 30, 'F');
            
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(255, 255, 255); // Texto branco
            pdf.text('Relatório Financeiro', pageWidth / 2, 20, { align: 'center' });
            yPos = 35;
            
            // Adicionar data
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(100, 100, 100); // Texto cinza
            pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            
            // Adicionar resumo com fundo
            pdf.setFillColor(245, 247, 250); // Cor de fundo clara
            pdf.rect(margin - 5, yPos - 5, pageWidth - margin*2 + 10, 100, 'F');
            
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(44, 62, 80); // Texto escuro
            pdf.text('Resumo Financeiro', margin, yPos);
            yPos += 10;
            
            // Calcular totais
            let totalIncome = 0;
            let totalExpense = 0;
            let totalPaid = 0;
            let totalPending = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.value;
                } else {
                    const expenseValue = Math.abs(transaction.value);
                    totalExpense += expenseValue;
                    
                    if (transaction.paga) {
                        totalPaid += expenseValue;
                    } else {
                        totalPending += expenseValue;
                    }
                }
            });
            
            const currentBalance = totalIncome - totalExpense;
            const expensePercent = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 0;
            const balancePercent = totalIncome > 0 ? (currentBalance / totalIncome) * 100 : 0;
            
            // Adicionar valores
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Renda Total: ${formatCurrency(totalIncome)}`, margin, yPos);
            yPos += 8;
            pdf.text(`Despesa Total: ${formatCurrency(totalExpense)} (${expensePercent.toFixed(1)}%)`, margin, yPos);
            yPos += 8;
            pdf.text(`Total Pago: ${formatCurrency(totalPaid)}`, margin, yPos);
            yPos += 8;
            pdf.text(`Total Pendente: ${formatCurrency(totalPending)}`, margin, yPos);
            yPos += 8;
            pdf.text(`Saldo Atual: ${formatCurrency(currentBalance)} (${balancePercent.toFixed(1)}%)`, margin, yPos);
            yPos += 15;
            
            // Adicionar transações
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Transações', margin, yPos);
            yPos += 10;
            
            // Cabeçalho da tabela
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.setFillColor(44, 62, 80); // Cor de fundo escura
            
            // Posições ajustadas para caber no A4
            const col1 = margin;          // Tipo (20mm)
            const col2 = margin + 22;      // Descrição (70mm)
            const col3 = margin + 92;      // Categoria (30mm)
            const col4 = margin + 122;     // Valor (30mm)
            const col5 = margin + 152;     // Paga? (20mm)
            
            // Desenhar fundo do cabeçalho
            pdf.rect(margin - 2, yPos - 2, pageWidth - margin*2 + 4, 10, 'F');
            
            pdf.setTextColor(255, 255, 255); // Texto branco
            pdf.text('Tipo', col1, yPos + 6);
            pdf.text('Descrição', col2, yPos + 6);
            pdf.text('Categoria', col3, yPos + 6);
            pdf.text('Valor', col4, yPos + 6);
            pdf.text('Paga?', col5, yPos + 6);
            yPos += 12;
            
            // Adicionar transações
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0); // Texto preto
            
            // Ordenar transações por data (mais recentes primeiro)
            const sortedTransactions = [...transactions].sort((a, b) => b.id - a.id);
            
            let rowCount = 0;
            
            sortedTransactions.forEach(transaction => {
                // Verificar se precisa de nova página
                if (yPos > pageHeight - 30) {
                    pdf.addPage();
                    yPos = margin;
                    
                    // Adicionar cabeçalho novamente na nova página
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFillColor(44, 62, 80);
                    pdf.rect(margin - 2, yPos - 2, pageWidth - margin*2 + 4, 10, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.text('Tipo', col1, yPos + 6);
                    pdf.text('Descrição', col2, yPos + 6);
                    pdf.text('Categoria', col3, yPos + 6);
                    pdf.text('Valor', col4, yPos + 6);
                    pdf.text('Paga?', col5, yPos + 6);
                    yPos += 12;
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    rowCount = 0;
                }
                
                const type = transaction.type === 'income' ? 'Renda' : 'Despesa';
                const description = transaction.description;
                const category = transaction.category;
                const value = formatCurrency(Math.abs(transaction.value));
                // Apenas despesas têm informação de pagamento
                const paid = transaction.type === 'expense' ? (transaction.paga ? 'Sim' : 'Não') : '';
                
                // Alternar cores de fundo
                if (rowCount % 2 === 0) {
                    pdf.setFillColor(248, 249, 250); // Fundo claro
                } else {
                    pdf.setFillColor(255, 255, 255); // Fundo branco
                }
                
                // Quebrar descrição longa em múltiplas linhas
                const maxDescWidth = 70; // Largura máxima da descrição em mm
                const descLines = pdf.splitTextToSize(description, maxDescWidth);
                
                // Calcular altura necessária para esta linha
                const lineHeight = 4;
                const cellHeight = Math.max(10, descLines.length * lineHeight);
                
                // Desenhar fundo da linha
                pdf.rect(margin - 2, yPos - 2, pageWidth - margin*2 + 4, cellHeight, 'F');
                
                // Escrever tipo (centralizado verticalmente)
                pdf.text(type, col1, yPos + (cellHeight/2) - 2);
                
                // Escrever descrição (com quebra de linha e centralizada verticalmente)
                const descStartY = yPos + (cellHeight - (descLines.length * lineHeight)) / 2;
                for (let i = 0; i < descLines.length; i++) {
                    pdf.text(descLines[i], col2, descStartY + (i * lineHeight));
                }
                
                // Escrever categoria (centralizada verticalmente)
                pdf.text(category, col3, yPos + (cellHeight/2) - 2);
                
                // Escrever valor (centralizada verticalmente)
                pdf.text(value, col4, yPos + (cellHeight/2) - 2);
                
                // Escrever status de pagamento (centralizada verticalmente)
                pdf.text(paid, col5, yPos + (cellHeight/2) - 2);
                
                // Linha divisória
                pdf.setDrawColor(200, 200, 200);
                pdf.setLineWidth(0.2);
                pdf.line(margin, yPos + cellHeight, pageWidth - margin, yPos + cellHeight);
                
                yPos += cellHeight + 2;
                rowCount++;
            });
            
            // Salvar o PDF
            pdf.save('relatorio_financeiro.pdf');
            
            notificationText.textContent = "Relatório PDF gerado com sucesso!";
            showExportNotification();
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            alert('Ocorreu um erro ao gerar o PDF. Tente novamente.');
        }
    }
    
    // Mostrar notificação de exportação/importação
    function showExportNotification() {
        exportNotification.style.display = 'block';
        setTimeout(() => {
            exportNotification.style.display = 'none';
        }, 3000);
    }
    
    // Função para voltar ao topo com animação suave
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    // Verifica a posição de rolagem para mostrar/ocultar o botão
    function toggleBackToTopButton() {
        if (window.scrollY > 300) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
    }
    
    // Compartilhar via WhatsApp
    function shareOnWhatsApp() {
        // Verificar se existem transações
        if (transactions.length === 0) {
            alert('Adicione transações antes de compartilhar!');
            return;
        }
        
        // Obter os dados resumidos
        let totalIncome = 0;
        let totalExpense = 0;
        let totalPaid = 0;
        let totalPending = 0;
        
        transactions.forEach(transaction => {
            if (transaction.type === 'income') {
                totalIncome += transaction.value;
            } else {
                const expenseValue = Math.abs(transaction.value);
                totalExpense += expenseValue;
                
                if (transaction.paga) {
                    totalPaid += expenseValue;
                } else {
                    totalPending += expenseValue;
                }
            }
        });
        
        const currentBalance = totalIncome - totalExpense;
        
        // Montar a mensagem para compartilhamento
        let message = `📊 *Resumo Financeiro* 📊\n\n`;
        message += `✅ *Renda Total:* ${formatCurrency(totalIncome)}\n`;
        message += `💸 *Despesa Total:* ${formatCurrency(totalExpense)}\n`;
        message += `💰 *Saldo Atual:* ${formatCurrency(currentBalance)}\n`;
        message += `✔️ *Total Pago:* ${formatCurrency(totalPaid)}\n`;
        message += `⏳ *Total Pendente:* ${formatCurrency(totalPending)}\n\n`;
        message += `_Gerado em ${new Date().toLocaleDateString('pt-BR')}_\n\n`;
        message += `👉 *Dicas de economia:*\n`;
        message += `- Revise suas despesas mensais\n`;
        message += `- Estabeleça metas de economia\n`;
        message += `- Priorize o pagamento de dívidas\n`;
        
        // Montar o link do WhatsApp
        const whatsappLink = `https://wa.me/?text=${encodeURIComponent(message)}`;
        
        // Abrir nova janela/tab para compartilhamento
        window.open(whatsappLink, '_blank');
        
        notificationText.textContent = "Compartilhando resumo via WhatsApp...";
        showExportNotification();
    }

    // --- Event Listeners ---
    addIncomeBtn.addEventListener('click', () => {
        addTransaction('income');
    });
    
    addExpenseBtn.addEventListener('click', () => {
        addTransaction('expense');
    });
    
    generateImageBtn.addEventListener('click', generateImage);
    exportCsvBtn.addEventListener('click', exportToCSV);
    exportPdfBtn.addEventListener('click', exportToPDF);
    exportJsonBtn.addEventListener('click', exportToJSON);
    updateBtn.addEventListener('click', updateTransaction);
    cancelBtn.addEventListener('click', cancelEditMode);
    shareWhatsappBtn.addEventListener('click', shareOnWhatsApp);
    
    // Botões mobile
    mobileImageBtn.addEventListener('click', generateImage);
    mobileCsvBtn.addEventListener('click', exportToCSV);
    mobilePdfBtn.addEventListener('click', exportToPDF);
    mobileJsonBtn.addEventListener('click', exportToJSON);
    mobileImportBtn.addEventListener('click', () => {
        fileNameDisplay.textContent = "Nenhum arquivo selecionado";
        confirmImportBtn.disabled = true;
        importOverlay.style.display = 'flex';
    });
    mobileWhatsappBtn.addEventListener('click', shareOnWhatsApp);
    
    // Importação de dados
    importDataBtn.addEventListener('click', () => {
        fileNameDisplay.textContent = "Nenhum arquivo selecionado";
        confirmImportBtn.disabled = true;
        importOverlay.style.display = 'flex';
    });
    
    closeImportModal.addEventListener('click', () => {
        importOverlay.style.display = 'none';
    });
    
    cancelImportBtn.addEventListener('click', () => {
        importOverlay.style.display = 'none';
    });
    
    // Ao mudar a categoria, esconder qualquer erro
    categoryInput.addEventListener('change', hideCategoryError);
    
    // Opções de importação
    document.querySelectorAll('input[name="import-option"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            importOption = e.target.value;
        });
    });
    
    // Seleção de arquivo para importação
    importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            fileNameDisplay.textContent = file.name;
            confirmImportBtn.disabled = false;
        } else {
            fileNameDisplay.textContent = "Nenhum arquivo selecionado";
            confirmImportBtn.disabled = true;
        }
    });
    
    // Confirmação de importação
    confirmImportBtn.addEventListener('click', () => {
        const file = importFileInput.files[0];
        if (file) {
            importFromJSON(file, importOption);
        }
    });
    
    // Botão voltar ao topo
    backToTopBtn.addEventListener('click', scrollToTop);
    window.addEventListener('scroll', toggleBackToTopButton);

    // Adicionar transações de exemplo
    function addSampleData() {
        if (transactions.length === 0) {
            transactions = [
                { id: Date.now(), description: "Salário", category: "Salário", value: 5000, type: "income" },
                { id: Date.now(), description: "Freelance", category: "Freelance", value: 1500, type: "income" },
                { id: Date.now(), description: "Aluguel", category: "Moradia", value: -1200, type: "expense", paga: false },
                { id: Date.now(), description: "Supermercado", category: "Alimentação", value: -450, type: "expense", paga: true },
                { id: Date.now(), description: "Transporte", category: "Transporte", value: -300, type: "expense", paga: false },
                { id: Date.now(), description: "Cinema", category: "Lazer", value: -150, type: "expense", paga: true }
            ];
            saveTransactions();
            updateUI();
        }
    }

    // Carrega as transações e atualiza a UI ao carregar a página
    document.addEventListener('DOMContentLoaded', () => {
        loadTransactions();
        addSampleData();
        
        // Inicializar o botão de voltar ao topo
        toggleBackToTopButton();
    });
</script>
</body>
</html>
